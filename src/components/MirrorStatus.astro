<script is:inline>
  //import { ArrowPath, Icon } from "svelte-hero-icons";

//import { setTextRange } from "typescript";

  function fetchData(url) {
    return fetch(url)
      .then(response => response.json())
      .catch(error => console.error('Error fetching data:', error));
  }

  function renderData(data) {
    const listContainer = document.getElementsByClassName("tbody");
    const dataList = data;

    listContainer.innerHTML = '';

    dataList.forEach(mirror => {
      document.getElementById('waiting').classList.add('hidden');
      const listItem = document.createElement('tr');
      
      listItem.classList.add('hover:bg-[#f4f6f7]');
      listItem.classList.add('border-t-2');
      if (mirror.status == "syncing") {
        listItem.classList.add('bg-amber-100');
      } else if (mirror.status == "failed") {
        listItem.classList.add('bg-red-100');
      }

      listItem.innerHTML = `
            <td class="lg:px-2 lg:py-3" data-label="Name">${mirror.name}</td>
            <td class="tabular-nums lg:px-2 lg:py-3" data-label="Next Schedule"
              >${mirror.next_schedule == "0001-01-01 00:00:00 +0000"
                ? mirror.last_started
                : mirror.next_schedule}</td>
            <td class="lg:px-2 lg:py-3" data-label="Upstream">${mirror.upstream}</td>
            <td class="lg:px-2 lg:py-3" data-label="Size">${mirror.size}</td>
            <td class="lg:px-2 lg:py-3" data-label="Status">${mirror.status}</td>`;
      listContainer[0].appendChild(listItem);
    });
    document.getElementById("table").classList.remove("hidden");
  }

  function startRender() {
    const apiUrl = 'https://mirrors.seu.edu.cn/-/api/tunasync.json';
    fetchData(apiUrl)
      .then(data => renderData(data))
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('waiting').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
      });
  }

  document.addEventListener('astro:page-load', startRender);

  document.addEventListener('astro:before-preparation', () => {
    document.removeEventListener('astro:page-load', startRender)
  });

</script>

<div class="px-4 py-3 flex flex-col w-full">
  <p class="font-medium text-xl flex items-center">
    <!-- Icon class="w-6 h-6 mr-2" src={ArrowPath} solid /-->
    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" class="w-6 h-6 mr-2"><path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0112.548-3.364l1.903 1.903h-3.183a.75.75 0 100 1.5h4.992a.75.75 0 00.75-.75V4.356a.75.75 0 00-1.5 0v3.18l-1.9-1.9A9 9 0 003.306 9.67a.75.75 0 101.45.388zm15.408 3.352a.75.75 0 00-.919.53 7.5 7.5 0 01-12.548 3.364l-1.902-1.903h3.183a.75.75 0 000-1.5H2.984a.75.75 0 00-.75.75v4.992a.75.75 0 001.5 0v-3.18l1.9 1.9a9 9 0 0015.059-4.035.75.75 0 00-.53-.918z" clip-rule="evenodd"></path></svg>
    同步状态
  </p>

  <p id="waiting">...waiting</p>

  <table class="mt-3 table-auto text-left border-collapse" id="table">
    <colgroup>
      <col />
      <col />
      <col />
      <col />
      <col />
    </colgroup>

    <thead class="row bg-gray-200 text-stone-800">
      <tr class="row bg-gray-200 text-stone-800">
        <th class="p-2">Name</th>
        <th class="p-2">Next Schedule</th>
        <th class="p-2">Upstream</th>
        <th class="p-2">Size</th>
        <th class="p-2">Status</th>
      </tr>
    </thead>

    <tbody class="tbody">

    </tbody>
  </table>

  <p class="hidden" id="error">An error occurred!</p>
</div>

<style>
  .hidden {
    display: none;
  }
</style>